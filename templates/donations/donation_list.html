{# templates/donations/donation_list.html #}
{% extends 'layout/base.html' %}
{% load humanize %}

{% block title %}Mes dons{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto px-4 py-6">

  <!-- Titre + bascule admin -->
  <div class="mb-6 flex items-center justify-between">
    <h1 class="text-2xl md:text-3xl font-bold text-gray-900">Mes Dons</h1>
    {% if request.user.is_staff %}
      <a href="?{% if showing_all %}{% else %}all=1{% endif %}{% for k,v in request.GET.items %}{% if k != 'all' %}&{{ k }}={{ v }}{% endif %}{% endfor %}"
        class="text-sm px-3 py-2 rounded-md border border-gray-300 hover:bg-gray-50">
        {% if showing_all %}Afficher seulement les miens{% else %}Voir tous (admin){% endif %}
      </a>
    {% endif %}
  </div>

  <!-- Stats -->
  <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
    <div class="rounded-lg p-5 text-white" style="background: linear-gradient(135deg,#2563eb,#38bdf8);">
      <div class="text-sm opacity-90">Total donné</div>
      <div class="text-2xl font-extrabold">{{ total_amount|intcomma }} XOF</div>
    </div>
    <div class="rounded-lg p-5 text-white" style="background: linear-gradient(135deg,#16a34a,#34d399);">
      <div class="text-sm opacity-90">Montant réussi</div>
      <div class="text-2xl font-extrabold">{{ success_amount|intcomma }} XOF</div>
      <div class="text-xs opacity-90 mt-1">{{ successful_count }} paiement(s)</div>
    </div>
    <div class="rounded-lg p-5 text-white" style="background: linear-gradient(135deg,#f59e0b,#fbbf24);">
      <div class="text-sm opacity-90">En attente</div>
      <div class="text-2xl font-extrabold">{{ pending_amount|intcomma }} XOF</div>
      <div class="text-xs opacity-90 mt-1">{{ pending_count }} paiement(s)</div>
    </div>
    <div class="rounded-lg p-5 text-white" style="background: linear-gradient(135deg,#ef4444,#fb7185);">
      <div class="text-sm opacity-90">Échoués</div>
      <div class="text-2xl font-extrabold">{{ failed_count }}</div>
    </div>
  </div>

  <!-- Filtres -->
  <form method="get" class="bg-white rounded-xl shadow-sm p-4 mb-6 grid grid-cols-1 md:grid-cols-5 gap-4">
    <div>
      <label class="block text-sm font-medium text-gray-700 mb-1">Statut</label>
      <select name="status" class="w-full rounded-lg border-gray-300">
        <option value="">Tous</option>
        {% for value, label in status_choices %}
          <option value="{{ value }}" {% if current_filters.status == value %}selected{% endif %}>
            {{ label }}
          </option>
        {% endfor %}
      </select>
    </div>

    <div>
      <label class="block text-sm font-medium text-gray-700 mb-1">Catégorie</label>
      <select name="category" class="w-full rounded-lg border-gray-300">
        <option value="">Toutes</option>
        {% for c in categories %}
          <option value="{{ c.code }}" {% if current_filters.category == c.code or current_filters.category == c.id|stringformat:"s" %}selected{% endif %}>
            {{ c.name }}
          </option>
        {% endfor %}
      </select>
    </div>

    <div>
      <label class="block text-sm font-medium text-gray-700 mb-1">Du</label>
      <input type="date" name="date_from" value="{{ current_filters.date_from }}" class="w-full rounded-lg border-gray-300">
    </div>

    <div>
      <label class="block text-sm font-medium text-gray-700 mb-1">Au</label>
      <input type="date" name="date_to" value="{{ current_filters.date_to }}" class="w-full rounded-lg border-gray-300">
    </div>

    <div class="flex items-end gap-2">
      <button type="submit" class="px-4 py-2 rounded-lg bg-blue-600 text-white hover:bg-blue-700">Filtrer</button>
      <a href="{% url 'donation-list' %}" class="px-4 py-2 rounded-lg border border-gray-300 hover:bg-gray-50">Réinitialiser</a>
    </div>
  </form>

  <!-- Tableau -->
  <div class="bg-white rounded-xl shadow-sm overflow-hidden">
    <div class="overflow-x-auto">
      <table class="min-w-full">
        <thead class="bg-gray-50">
          <tr>
            <th class="px-6 py-3 text-left text-xs font-semibold text-gray-500">Référence</th>
            <th class="px-6 py-3 text-left text-xs font-semibold text-gray-500">Catégorie</th>
            <th class="px-6 py-3 text-left text-xs font-semibold text-gray-500">Montant</th>
            <th class="px-6 py-3 text-left text-xs font-semibold text-gray-500">Statut</th>
            <th class="px-6 py-3 text-left text-xs font-semibold text-gray-500">Créé le</th>
            <th class="px-6 py-3 text-left text-xs font-semibold text-gray-500">Actions</th>
          </tr>
        </thead>
        <tbody class="divide-y divide-gray-200">
          {% for d in donations %}
            <tr class="hover:bg-gray-50">
              <td class="px-6 py-4 text-sm font-mono">
                {{ d.reference|truncatechars:16 }}
              </td>
              <td class="px-6 py-4 text-sm">
                <span class="inline-flex items-center px-2 py-1 rounded-full bg-blue-100 text-blue-800 text-xs font-semibold">
                  {{ d.category.name }}
                </span>
              </td>
              <td class="px-6 py-4 text-sm font-semibold">
                {{ d.amount|intcomma }} {{ d.currency }}
              </td>
              <td class="px-6 py-4 text-sm">
                {% if d.status == 'success' %}
                  <span class="px-2 py-1 text-xs font-semibold rounded-full bg-green-100 text-green-800">Réussi</span>
                {% elif d.status == 'pending' %}
                  <span class="px-2 py-1 text-xs font-semibold rounded-full bg-yellow-100 text-yellow-800">En attente</span>
                {% elif d.status == 'failed' %}
                  <span class="px-2 py-1 text-xs font-semibold rounded-full bg-red-100 text-red-800">Échoué</span>
                {% else %}
                  <span class="px-2 py-1 text-xs font-semibold rounded-full bg-gray-100 text-gray-800">{{ d.status }}</span>
                {% endif %}
              </td>
              <td class="px-6 py-4 text-sm text-gray-600">
                {{ d.created_at|date:"d/m/Y H:i" }}
              </td>
              <td class="px-6 py-4 text-sm">
                <a href="{% url 'donation-detail' d.pk %}" class="text-blue-600 hover:underline mr-3">Détails</a>
                {% if d.status == 'pending' and d.authorization_url %}
                  <a href="{{ d.authorization_url }}" class="text-indigo-600 hover:underline" target="_blank" rel="noopener">Payer</a>
                {% endif %}
              </td>
            </tr>
          {% empty %}
            <tr>
              <td colspan="6" class="px-6 py-10 text-center text-gray-500">
                Aucun don trouvé. Effectuez votre premier don depuis l’application mobile.
              </td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>

    <!-- Pagination -->
    {% if is_paginated %}
      <div class="px-6 py-4 bg-gray-50 border-t border-gray-200 flex items-center justify-between">
        <div class="text-sm text-gray-600">
          Page {{ page_obj.number }} / {{ page_obj.paginator.num_pages }}
        </div>
        <div class="flex gap-2">
          {% if page_obj.has_previous %}
            <a class="px-3 py-1 border rounded-md text-sm" href="?page=1{% for k,v in request.GET.items %}{% if k != 'page' %}&{{ k }}={{ v }}{% endif %}{% endfor %}">Première</a>
            <a class="px-3 py-1 border rounded-md text-sm" href="?page={{ page_obj.previous_page_number }}{% for k,v in request.GET.items %}{% if k != 'page' %}&{{ k }}={{ v }}{% endif %}{% endfor %}">Précédent</a>
          {% endif %}
          {% if page_obj.has_next %}
            <a class="px-3 py-1 border rounded-md text-sm" href="?page={{ page_obj.next_page_number }}{% for k,v in request.GET.items %}{% if k != 'page' %}&{{ k }}={{ v }}{% endif %}{% endfor %}">Suivant</a>
            <a class="px-3 py-1 border rounded-md text-sm" href="?page={{ page_obj.paginator.num_pages }}{% for k,v in request.GET.items %}{% if k != 'page' %}&{{ k }}={{ v }}{% endif %}{% endfor %}">Dernière</a>
          {% endif %}
        </div>
      </div>
    {% endif %}
  </div>
</div>
{% endblock %}